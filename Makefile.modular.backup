# Makefile.modular - Modular TestGen Build System
# Supports multiple web applications with independent configurations

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -I. -Iconfigs -g -O2

# Target executables
TARGET_BASIC = testgen_modular_basic
TARGET_SYMBOLIC = testgen_modular_symbolic

# Core modular sources (new architecture)
MODULAR_SOURCES = \
    WebAppConfig.cpp \
    ModularTestGen.cpp \
    test_modular_application.cpp

# Code generation sources (existing)
CODEGEN_SOURCES = \
    jsCodeGenerator/jsCodeGen.cpp

# Symbolic engine sources (existing)
SYMBOLIC_SOURCES = \
    SymbolicEngine/TestGenSymbolicEnv.cpp \
    SymbolicEngine/TestGenSymbolicVisitor.cpp \
    SymbolicEngine/TestGenDriver.cpp

# All source combinations
BASIC_SOURCES = $(MODULAR_SOURCES) $(CODEGEN_SOURCES)
FULL_SOURCES = $(BASIC_SOURCES) $(SYMBOLIC_SOURCES)

# Object files
MODULAR_OBJS = $(MODULAR_SOURCES:.cpp=.o)
CODEGEN_OBJS = $(CODEGEN_SOURCES:.cpp=.o)
SYMBOLIC_OBJS = $(SYMBOLIC_SOURCES:.cpp=.o)

# Phony targets
.PHONY: all basic symbolic clean rebuild test help

# Default target - build basic version
all: basic

# Basic version (modular + code generation, no symbolic)
basic: $(TARGET_BASIC)

$(TARGET_BASIC): $(BASIC_SOURCES)
	@echo "Building basic modular testgen..."
	$(CXX) $(CXXFLAGS) $^ -o $@
	@echo "✓ Build complete: $(TARGET_BASIC)"

# Symbolic version (modular + code generation + symbolic execution)
symbolic: $(TARGET_SYMBOLIC)

$(TARGET_SYMBOLIC): $(FULL_SOURCES)
	@echo "Building modular testgen with symbolic engine..."
	$(CXX) $(CXXFLAGS) -ISymbolicEngine -DUSE_SYMBOLIC_ENGINE $^ -o $@
	@echo "✓ Build complete: $(TARGET_SYMBOLIC)"

# Compile individual object files (if needed)
%.o: %.cpp
	@echo "Compiling $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Dependencies
WebAppConfig.o: WebAppConfig.cpp WebAppConfig.hpp ast.hpp
ModularTestGen.o: ModularTestGen.cpp ModularTestGen.hpp WebAppConfig.hpp ast.hpp algo.hpp symbol_table.hpp
test_modular_application.o: test_modular_application.cpp \
    WebAppConfig.hpp ModularTestGen.hpp \
    configs/TourismConfig.hpp \
    configs/PesuFoodsConfig.hpp \
    configs/LibraryConfig.hpp \
    ast.hpp algo.hpp symbol_table.hpp

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	rm -f $(TARGET_BASIC) $(TARGET_SYMBOLIC)
	rm -f *.o jsCodeGenerator/*.o SymbolicEngine/*.o
	rm -f testgen_*.js testgen_*.smt2 concrete_*.txt
	@echo "✓ Clean complete"

# Rebuild everything
rebuild: clean all

# Run tests with basic version
test: basic
	@echo "\n=== Running Modular TestGen Tests ===\n"
	@echo "1. List applications:"
	./$(TARGET_BASIC) --list
	@echo "\n2. List Tourism scenarios:"
	./$(TARGET_BASIC) --list-scenarios tourism
	@echo "\n3. Run Tourism scenario 1:"
	./$(TARGET_BASIC) tourism tourism_scenario_1
	@echo "\n4. Run PESU Foods scenario 1:"
	./$(TARGET_BASIC) pesu_foods pesu_foods_scenario_1
	@echo "\n5. Run Library scenario 1:"
	./$(TARGET_BASIC) library library_scenario_1
	@echo "\n✓ All tests complete\n"

# Run tests with symbolic version
test-symbolic: symbolic
	@echo "\n=== Running Modular TestGen Tests (with Symbolic Execution) ===\n"
	./$(TARGET_SYMBOLIC) tourism tourism_scenario_1 --symbolic
	@echo "\n✓ Symbolic test complete\n"

# Help message
help:
	@echo "TestGen Modular Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all           - Build basic version (default)"
	@echo "  basic         - Build modular testgen (no symbolic)"
	@echo "  symbolic      - Build modular testgen + symbolic execution"
	@echo "  clean         - Remove all build artifacts"
	@echo "  rebuild       - Clean and build basic version"
	@echo "  test          - Build and run tests (basic version)"
	@echo "  test-symbolic - Build and run tests (symbolic version)"
	@echo "  help          - Show this help message"
	@echo ""
	@echo "Usage:"
	@echo "  make -f Makefile.modular                # Build basic"
	@echo "  make -f Makefile.modular basic          # Build basic"
	@echo "  make -f Makefile.modular symbolic       # Build with symbolic engine"
	@echo "  make -f Makefile.modular clean          # Clean"
	@echo "  make -f Makefile.modular test           # Run tests"
	@echo ""
	@echo "After building, run:"
	@echo "  ./testgen_modular_basic --help          # Show usage"
	@echo "  ./testgen_modular_basic --list          # List apps"
	@echo "  ./testgen_modular_basic tourism tourism_scenario_1  # Run test"
	@echo ""
	@echo "With symbolic execution:"
	@echo "  ./testgen_modular_symbolic tourism tourism_scenario_1 --symbolic"
	@echo ""
	@echo "Architecture:"
	@echo "  Modular:      WebAppConfig, ModularTestGen, test_modular_application"
	@echo "  Code Gen:     jsCodeGenerator/jsCodeGen.cpp"
	@echo "  Symbolic:     SymbolicEngine/TestGen*.cpp"
	@echo "  Configs:      configs/TourismConfig.hpp, PesuFoodsConfig.hpp, LibraryConfig.hpp"
